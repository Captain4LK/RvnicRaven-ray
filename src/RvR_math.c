/*
RvnicRaven retro game engine

Written in 2021 by Lukas Holzbeierlein (Captain4LK) email: captain4lk [at] tutanota [dot] com

To the extent possible under law, the author(s) have dedicated all copyright and related and neighboring rights to this software to the public domain worldwide. This software is distributed without any warranty.

You should have received a copy of the CC0 Public Domain Dedication along with this software. If not, see <http://creativecommons.org/publicdomain/zero/1.0/>. 
*/

//External includes
#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <limits.h>
//-------------------------------------

//Internal includes
#include "RvnicRaven.h"
//-------------------------------------

//#defines

#define TYPE_NAME(pow) \
   RvR_fix##pow

#define AND(pow) \
   (INT32_MAX-((1<<(32-pow))-1))

#define FROM_INT(pow) \
   TYPE_NAME(pow) RvR_fix##pow##_from_int(int a) \
   { \
      return (TYPE_NAME(pow))a*(1<<(32-pow)); \
   }

#define TO_INT(pow) \
   int RvR_fix##pow##_to_int(TYPE_NAME(pow)a) \
   { \
      return (int)(a/(1<<(32-pow)));\
   }

#define MUL(pow) \
   TYPE_NAME(pow) RvR_fix##pow##_mul(TYPE_NAME(pow) a, TYPE_NAME(pow) b) \
   { \
      int64_t p = (int64_t)a*(int64_t)b; \
      return (TYPE_NAME(pow))(p/(1<<(32-pow))); \
   }

#define DIV(pow) \
   TYPE_NAME(pow) RvR_fix##pow##_div(TYPE_NAME(pow) a, TYPE_NAME(pow) b) \
   { \
      int64_t p = (int64_t)a*(1<<(32-pow)); \
      return (TYPE_NAME(pow))(p/(int64_t)b); \
   }

#define ROUND(pow) \
   TYPE_NAME(pow) RvR_fix##pow##_round(TYPE_NAME(pow) a) \
   { \
      int sign = RvR_sign(a); \
      a*=sign; \
      a = ((a+((TYPE_NAME(pow))1<<(32-pow-1))))&AND(pow); \
      a*=sign; \
      return a; \
   }

#define FLOOR(pow) \
   TYPE_NAME(pow) RvR_fix##pow##_floor(TYPE_NAME(pow) a) \
   { \
      int sign = RvR_sign(a); \
      a*=sign; \
      a&=AND(pow); \
      a*=sign; \
      return a; \
   }

#define CEIL(pow) \
   TYPE_NAME(pow) RvR_fix##pow##_ceil(TYPE_NAME(pow) a) \
   { \
      int sign = RvR_sign(a); \
      a*=sign; \
      a = (a+((1<<(32-pow))-1))&AND(pow); \
      a*=sign; \
      return a; \
   }

#define SQRT(type,con,shift) \
   type type##_sqrt(type in) { in*=sign; con result = 0, a = (con)in<<(shift/2), b = (con)1L<<(shift*2-2); while(b>a) b>>=2; \
   while(b) { if(a>=result+b) { a-=result+b; result = result+2*b; } b>>=2; result>>=1; } return result; }

//-------------------------------------

//Typedefs
//-------------------------------------

//Variables

static const RvR_fix22 math_cos_table22[1024] =
{
   1024,1023,1023,1023,1023,1023,1023,1023,1022,1022,1022,1021,1021,1020,1020,1019,
   1019,1018,1017,1017,1016,1015,1014,1013,1012,1011,1010,1009,1008,1007,1006,1005,
   1004,1003,1001,1000,999,997,996,994,993,991,990,988,986,985,983,981,
   979,978,976,974,972,970,968,966,964,962,959,957,955,953,950,948,
   946,943,941,938,936,933,930,928,925,922,920,917,914,911,908,906,
   903,900,897,894,890,887,884,881,878,875,871,868,865,861,858,854,
   851,847,844,840,837,833,829,826,822,818,814,811,807,803,799,795,
   791,787,783,779,775,771,767,762,758,754,750,745,741,737,732,728,
   724,719,715,710,706,701,696,692,687,683,678,673,668,664,659,654,
   649,644,639,634,629,625,620,615,609,604,599,594,589,584,579,574,
   568,563,558,553,547,542,537,531,526,521,515,510,504,499,493,488,
   482,477,471,466,460,454,449,443,437,432,426,420,414,409,403,397,
   391,386,380,374,368,362,356,350,344,339,333,327,321,315,309,303,
   297,291,285,279,273,267,260,254,248,242,236,230,224,218,212,205,
   199,193,187,181,175,168,162,156,150,144,137,131,125,119,112,106,
   100,94,87,81,75,69,62,56,50,43,37,31,25,18,12,6,
   0,-6,-12,-18,-25,-31,-37,-43,-50,-56,-62,-69,-75,-81,-87,-94,
   -100,-106,-112,-119,-125,-131,-137,-144,-150,-156,-162,-168,-175,-181,-187,-193,
   -199,-205,-212,-218,-224,-230,-236,-242,-248,-254,-260,-267,-273,-279,-285,-291,
   -297,-303,-309,-315,-321,-327,-333,-339,-344,-350,-356,-362,-368,-374,-380,-386,
   -391,-397,-403,-409,-414,-420,-426,-432,-437,-443,-449,-454,-460,-466,-471,-477,
   -482,-488,-493,-499,-504,-510,-515,-521,-526,-531,-537,-542,-547,-553,-558,-563,
   -568,-574,-579,-584,-589,-594,-599,-604,-609,-615,-620,-625,-629,-634,-639,-644,
   -649,-654,-659,-664,-668,-673,-678,-683,-687,-692,-696,-701,-706,-710,-715,-719,
   -724,-728,-732,-737,-741,-745,-750,-754,-758,-762,-767,-771,-775,-779,-783,-787,
   -791,-795,-799,-803,-807,-811,-814,-818,-822,-826,-829,-833,-837,-840,-844,-847,
   -851,-854,-858,-861,-865,-868,-871,-875,-878,-881,-884,-887,-890,-894,-897,-900,
   -903,-906,-908,-911,-914,-917,-920,-922,-925,-928,-930,-933,-936,-938,-941,-943,
   -946,-948,-950,-953,-955,-957,-959,-962,-964,-966,-968,-970,-972,-974,-976,-978,
   -979,-981,-983,-985,-986,-988,-990,-991,-993,-994,-996,-997,-999,-1000,-1001,-1003,
   -1004,-1005,-1006,-1007,-1008,-1009,-1010,-1011,-1012,-1013,-1014,-1015,-1016,-1017,-1017,-1018,
   -1019,-1019,-1020,-1020,-1021,-1021,-1022,-1022,-1022,-1023,-1023,-1023,-1023,-1023,-1023,-1023,
   -1024,-1023,-1023,-1023,-1023,-1023,-1023,-1023,-1022,-1022,-1022,-1021,-1021,-1020,-1020,-1019,
   -1019,-1018,-1017,-1017,-1016,-1015,-1014,-1013,-1012,-1011,-1010,-1009,-1008,-1007,-1006,-1005,
   -1004,-1003,-1001,-1000,-999,-997,-996,-994,-993,-991,-990,-988,-986,-985,-983,-981,
   -979,-978,-976,-974,-972,-970,-968,-966,-964,-962,-959,-957,-955,-953,-950,-948,
   -946,-943,-941,-938,-936,-933,-930,-928,-925,-922,-920,-917,-914,-911,-908,-906,
   -903,-900,-897,-894,-890,-887,-884,-881,-878,-875,-871,-868,-865,-861,-858,-854,
   -851,-847,-844,-840,-837,-833,-829,-826,-822,-818,-814,-811,-807,-803,-799,-795,
   -791,-787,-783,-779,-775,-771,-767,-762,-758,-754,-750,-745,-741,-737,-732,-728,
   -724,-719,-715,-710,-706,-701,-696,-692,-687,-683,-678,-673,-668,-664,-659,-654,
   -649,-644,-639,-634,-629,-625,-620,-615,-609,-604,-599,-594,-589,-584,-579,-574,
   -568,-563,-558,-553,-547,-542,-537,-531,-526,-521,-515,-510,-504,-499,-493,-488,
   -482,-477,-471,-466,-460,-454,-449,-443,-437,-432,-426,-420,-414,-409,-403,-397,
   -391,-386,-380,-374,-368,-362,-356,-350,-344,-339,-333,-327,-321,-315,-309,-303,
   -297,-291,-285,-279,-273,-267,-260,-254,-248,-242,-236,-230,-224,-218,-212,-205,
   -199,-193,-187,-181,-175,-168,-162,-156,-150,-144,-137,-131,-125,-119,-112,-106,
   -100,-94,-87,-81,-75,-69,-62,-56,-50,-43,-37,-31,-25,-18,-12,-6,
   0,6,12,18,25,31,37,43,50,56,62,69,75,81,87,94,
   100,106,112,119,125,131,137,144,150,156,162,168,175,181,187,193,
   199,205,212,218,224,230,236,242,248,254,260,267,273,279,285,291,
   297,303,309,315,321,327,333,339,344,350,356,362,368,374,380,386,
   391,397,403,409,414,420,426,432,437,443,449,454,460,466,471,477,
   482,488,493,499,504,510,515,521,526,531,537,542,547,553,558,563,
   568,574,579,584,589,594,599,604,609,615,620,625,629,634,639,644,
   649,654,659,664,668,673,678,683,687,692,696,701,706,710,715,719,
   724,728,732,737,741,745,750,754,758,762,767,771,775,779,783,787,
   791,795,799,803,807,811,814,818,822,826,829,833,837,840,844,847,
   851,854,858,861,865,868,871,875,878,881,884,887,890,894,897,900,
   903,906,908,911,914,917,920,922,925,928,930,933,936,938,941,943,
   946,948,950,953,955,957,959,962,964,966,968,970,972,974,976,978,
   979,981,983,985,986,988,990,991,993,994,996,997,999,1000,1001,1003,
   1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1015,1016,1017,1017,1018,
   1019,1019,1020,1020,1021,1021,1022,1022,1022,1023,1023,1023,1023,1023,1023,1023,
};

static const RvR_fix22 math_atan_table22[2048] = 
{
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
   0,0,1,1,2,3,3,4,4,5,6,6,7,7,8,9,9,10,10,11,11,12,12,13,13,14,14,15,16,16,17,17,
   18,18,19,19,19,20,20,21,21,22,22,23,23,24,24,25,25,25,26,26,27,27,28,28,28,29,29,30,30,30,31,31,
   32,32,32,33,33,34,34,34,35,35,35,36,36,37,37,37,38,38,38,39,39,39,40,40,40,41,41,41,42,42,42,43,
   43,43,44,44,44,44,45,45,45,46,46,46,47,47,47,47,48,48,48,48,49,49,49,50,50,50,50,51,51,51,51,52,
   52,52,52,53,53,53,53,54,54,54,54,55,55,55,55,56,56,56,56,57,57,57,57,57,58,58,58,58,58,59,59,59,
   59,60,60,60,60,60,61,61,61,61,61,62,62,62,62,62,63,63,63,63,63,63,64,64,64,64,64,65,65,65,65,65,
   65,66,66,66,66,66,67,67,67,67,67,67,68,68,68,68,68,68,69,69,69,69,69,69,69,70,70,70,70,70,70,71,
   71,71,71,71,71,71,72,72,72,72,72,72,72,73,73,73,73,73,73,73,73,74,74,74,74,74,74,74,75,75,75,75,
   75,75,75,75,76,76,76,76,76,76,76,76,77,77,77,77,77,77,77,77,77,78,78,78,78,78,78,78,78,79,79,79,
   79,79,79,79,79,79,80,80,80,80,80,80,80,80,80,80,81,81,81,81,81,81,81,81,81,81,82,82,82,82,82,82,
   82,82,82,82,83,83,83,83,83,83,83,83,83,83,83,84,84,84,84,84,84,84,84,84,84,84,85,85,85,85,85,85,
   85,85,85,85,85,85,86,86,86,86,86,86,86,86,86,86,86,86,86,87,87,87,87,87,87,87,87,87,87,87,87,87,
   88,88,88,88,88,88,88,88,88,88,88,88,88,89,89,89,89,89,89,89,89,89,89,89,89,89,89,90,90,90,90,90,
   90,90,90,90,90,90,90,90,90,90,90,91,91,91,91,91,91,91,91,91,91,91,91,91,91,91,91,92,92,92,92,92,
   92,92,92,92,92,92,92,92,92,92,92,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,94,94,94,
   94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,
   95,95,95,95,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,97,97,97,97,97,97,97,
   97,97,97,97,97,97,97,97,97,97,97,97,97,97,97,97,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,
   98,98,98,98,98,98,98,98,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,
   99,99,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,101,101,
   101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,102,102,102,102,
   102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,103,103,103,103,
   103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,104,
   104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,
   104,104,104,104,104,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,
   105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,
   106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,107,107,107,107,
   107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,
   107,107,107,107,107,107,107,107,107,107,107,107,107,107,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,
   108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,
   108,108,108,108,108,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,
   109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,
   109,109,109,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,
   110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,
   110,110,110,110,110,110,110,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,
   111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,
   111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,112,112,112,112,112,112,112,112,112,112,112,112,
   112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,
   112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,
   112,112,112,112,112,112,112,112,112,112,112,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,
   113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,
   113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,
   113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,
   114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,
   114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,
   114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,
   114,114,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,
   115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,
   115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,
   115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,
   115,115,115,115,115,115,115,115,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,
   116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,
   116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,
   116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,
   116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,
   116,116,116,116,116,116,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,
   117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,
   117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,
   117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,
   117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,
};
//-------------------------------------

//Function prototypes
//-------------------------------------

//Function implementations

FROM_INT(16)
FROM_INT(22)
FROM_INT(24)

TO_INT(16)
TO_INT(22)
TO_INT(24)

MUL(16)
MUL(22)
MUL(24)

DIV(16)
DIV(22)
DIV(24)

ROUND(16)
ROUND(22)
ROUND(24)

FLOOR(16)
FLOOR(22)
FLOOR(24)

CEIL(16)
CEIL(22)
CEIL(24)

RvR_fix22 RvR_fix22_cos(RvR_fix22 a)
{
   return math_cos_table22[a&1023];
}

RvR_fix22 RvR_fix22_sin(RvR_fix22 a)
{
   return RvR_fix22_cos(a-256);
}

RvR_fix22 RvR_fix22_tan(RvR_fix22 a)
{
   return (RvR_fix22_sin(a)*1024)/RvR_non_zero(RvR_fix22_cos(a));
}

RvR_fix22 RvR_fix22_ctg(RvR_fix22 a)
{
   return (RvR_fix22_cos(a)*1024)/RvR_fix22_sin(a);
}

RvR_fix22 RvR_fix22_atan2(RvR_fix22 x, RvR_fix22 y)
{
   if(y==0)
   {
      if(x>0)
         return 0;
      return 512;
   }

   if(x==0)
   {
      if(y>0)
         return 256;
      return 768;
   }

   if(x>0)
   {
      if(y>0)
      {
         if(x>y)
         {
            RvR_fix22 a = (x*128)/y;
            if(a>=2048)
               return 0;
            return 128-math_atan_table22[a];
         }

         RvR_fix22 a = (y*128)/x;
         if(a>=2048)
            return 256;
         return 128+math_atan_table22[a];
      }

      if(x>-y)
      {
         RvR_fix22 a = (x*128)/(-y);
         if(a>=2048)
            return 0;
         return 896+math_atan_table22[a];
      }

      RvR_fix22 a = (-y*128)/x;
      if(a>=2048)
         return 768;
      return 896-math_atan_table22[a];
   }

   if(y>0)
   {
      if(-x>y)
      {
         RvR_fix22 a = (-x*128)/y;
         if(a>=2048)
            return 512;
         return 384+math_atan_table22[a];
      }

      RvR_fix22 a = (y*128)/(-x);
      if(a>=2048)
         return 256;
      return 384-math_atan_table22[a];
   }

   if(-x>-y)
   {
      RvR_fix22 a = (x*128)/y;
      if(a>=2048)
         return 512;
      return 640-math_atan_table22[a];
   }

   RvR_fix22 a = (y*128)/x;
   if(a>=2048)
      return 768;
   return 640+math_atan_table22[a];
}

RvR_fix22 RvR_fix22_sqrt(RvR_fix22 a)
{
   RvR_fix22 b = 1<<30;
   RvR_fix22 result = 0;

   while(b>64)
   {
      RvR_fix22 t = result+b;
      if(a>=t)
      {
         a-=t;
         result = t+b;
      }
      a<<=1;
      b>>=1;
   }

   return result>>11;
}

int32_t RvR_div_round_down(int32_t a, int32_t b)
{
  return a/b-((a>=0)?0:1);
}

RvR_vec2 RvR_vec2_rot(RvR_fix22 angle)
{
   RvR_vec2 result;

   result.x = RvR_fix22_cos(angle);
   result.y = RvR_fix22_sin(angle);

   return result;
}

RvR_fix22 RvR_dist2(RvR_vec2 p0, RvR_vec2 p1)
{
   RvR_fix22 dx = p1.x-p0.x;
   RvR_fix22 dy = p1.y-p0.y;

  dx = (dx*dx)/1024;
  dy = (dy*dy)/1024;

  return RvR_fix22_sqrt(dx+dy);
}

RvR_fix22 RvR_len2(RvR_vec2 v)
{
   RvR_vec2 zero = {0};

   return RvR_dist2(zero,v);
}

int32_t RvR_abs(int32_t a)
{
   return a*(((a>=0)<<1)-1);
}

//Like mod, but behaves differently for negative values.
int32_t RvR_wrap(int32_t a, int32_t mod)
{
   int32_t cmp = a<0;
   return cmp*mod+(a%mod)-cmp;
}
//-------------------------------------

#undef TYPE_NAME
#undef AND
#undef FROM_INT
#undef TO_INT
#undef MUL
#undef DIV
#undef ROUND
#undef FLOOR
#undef CEIL
